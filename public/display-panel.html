<!doctype html>

<head>

<script src="/socket.io/socket.io.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>

<link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/css/bootstrap.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/js/bootstrap.min.js"></script>

<link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.11/c3.min.css">
<script src="/javascripts/c3.js"></script>

<link type="text/css" rel="stylesheet" href="/stylesheets/display_panel.css">

</head>

<body>

<div class="container-fluid">
    <div class="row vertical-center">
        <div id="chart" class="col-md-9"></div>
        <div id="current-display" class="col-md-1 col-md-offset-1">
            <div class="row current-display-box">
                <h1 class="current-display-label">Time:</h1>
                <h2 id="current-time-display" class="current-display">00:00</h2>
            </div>
            <div class="row current-display-box">
                <h1 class="current-display-label">SpO<sub>2</sub>:</h1>
                <h2 id="current-spo2-display" class="current-display">0%</h2>
            </div>
            <div class="row current-display-box">
                <h1 class="current-display-label">FiO<sub>2</sub>:</h1>
                <h2 id="current-fio2-display" class="current-display">0%</h2>
            </div>
        </div>
    </div>
    <div class="row">
        <span id="status-connection" class="label label-danger">Not connected to sensors!</span>
    </div>
</div>

<script>

function updateStatusConnected() {
    var statusElem = document.getElementById('status-connection');
    statusElem.innerHTML = 'Connected to sensors';
    statusElem.className = 'label label-default';
    statusElem.style.visibility = 'hidden';
}
function updateStatusDisconnected() {
    var statusElem = document.getElementById('status-connection');
    statusElem.innerHTML = 'Not connected to sensors!';
    statusElem.className = 'label label-danger';
    statusElem.style.visibility = 'visible';
}

function toDateString(totalSeconds) {
    var minutes = parseInt(totalSeconds / 60) % 60;
    var seconds = totalSeconds % 60;
    return (minutes < 10 ? '0' + minutes : minutes) + ':' + (seconds < 10 ? '0' + seconds : seconds);
}
function fromDateString(dateString) {
    var a = dateString.split(':');
    return a[0] * 60 + a[1] * 1;
}

var chart = c3.generate({
    bindto: '#chart',
    size: {
        //width: 1000,
        height: 600,
    },
    data: {
        xs: {
            targetUpper: 'targetTime',
            targetLower: 'targetTime',
            SpO2: 'signalTime',
            FiO2: 'signalTime'
        },
        xFormat: '%M:%S',
        columns: [
            ['targetTime', toDateString(60), toDateString(300), toDateString(600), toDateString(2400)],
            ['targetUpper', 0.65, 0.85, 0.95, 0.95],
            ['targetLower', 0.6, 0.8, 0.85, 0.85],
            ['signalTime'],
            ['SpO2'],
            ['FiO2']
        ],
        types: {
            targetLower: 'area',
            targetUpper: 'area',
            SpO2: 'line',
            FiO2: 'line'
        },
        axes: {
            targetLower: 'y',
            targetUpper: 'y',
            SpO2: 'y',
            FiO2: 'y2'
        },
        colors: {
            targetLower: 'white',
            targetUpper: 'salmon',
            SpO2: 'darkred',
            FiO2: 'black'
        }
    },
    axis: {
        x: {
            label: {
                text: 'Time (min)',
                position: 'outer-center'
            },
            type: 'timeseries',
            tick: {
                format: '%M:%S',
                fit: false,
                culling: {
                    max: 10
                }
            },
            min: toDateString(0),
            max: toDateString(600),
            padding: 0,
            height: 60
        },
        y: {
            label: {
                text: 'SpO2 (%)',
                position: 'outer-middle'
            },
            show: true,
            tick: {
                format: d3.format('%')
            },
            min: 0,
            max: 1,
            padding: 0
        },
        y2: {
            label: {
                text: 'FiO2 (%)',
                position: 'outer-middle'
            },
            show: true,
            tick: {
                format: d3.format('%')
            },
            min: 0,
            max: 1,
            padding: 0
        }
    },
    legend: {
        show: false
    },
    tooltip: {
        show: false
    },
    point: {
        show: false
    },
    padding: {
        top: 20,
        left: 100,
        right: 100,
        bottom: 40
    }
});

function setCurrentDisplay(time, spO2, fiO2) {
    document.getElementById('current-time-display').innerHTML = toDateString(time);
    document.getElementById('current-spo2-display').innerHTML = Math.round(spO2 * 100) + '%';
    document.getElementById('current-fio2-display').innerHTML = Math.round(fiO2 * 100) + '%';
}

function updateDisplay(time, spO2, fiO2) {
    var dateString = toDateString(time);
    if (time > 600) {
        chart.axis.max({x: dateString});
        chart.axis.tickFit(true);
        chart.axis.tickCount(9);
    }
    chart.flow({
        columns: [
            ['signalTime', dateString],
            ['SpO2', spO2],
            ['FiO2', fiO2]
        ],
        duration: 0,
        to: toDateString(0),
    });
    setCurrentDisplay(time, spO2, fiO2);
}

var socket = io.connect(window.location.host);
socket.on('connect', function(data) {
    socket.emit('connected', {client: 'display-panel'});
    console.log('Sockets: Connected to server.');
    chart.unload({
        ids: ['signalTime', 'SpO2']
    });
    document.getElementById('current-fio2-display').innerHTML = '0%';
    updateStatusConnected();
})
socket.on('disconnect', function(data) {
    console.log('Sockets: Disconnected from server.');
    updateStatusDisconnected();
})
socket.on('initialize', function(data) {
    if (data === null) {
        console.log('Sockets: Initializing.');
        return;
    } else {
        console.log('Sockets: Initializing with previous data.');
    }
    setCurrentDisplay(data.time[data.time.length - 1], data.spO2[data.spO2.length - 1], data.fiO2[data.fiO2.length - 1]);
    var time = data.time.map(toDateString);
    time.unshift('signalTime');
    var spO2Signal = data.spO2;
    spO2Signal.unshift('SpO2');
    var fiO2Signal = data.fiO2;
    fiO2Signal.unshift('FiO2');
    chart.load({
        columns: [
            time,
            spO2Signal,
            fiO2Signal
        ]
    });
});
socket.on('update', function(data) {
    updateDisplay(data.time, data.spO2, data.fiO2);
});
socket.on('reset', function(data) {
    console.log('Sockets: Resetting data.');
    chart.unload({
        ids: ['signalTime', 'SpO2', 'FiO2']
    });
    setCurrentDisplay(data.time, data.spO2, data.fiO2);
});
</script>

</body>
