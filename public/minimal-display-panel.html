<!doctype html>

<head>

<script src="/socket.io/socket.io.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>

<link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/css/bootstrap.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/js/bootstrap.min.js"></script>

<link type="text/css" rel="stylesheet" href="/stylesheets/texgyreheros.css">
<link type="text/css" rel="stylesheet" href="/stylesheets/display_panel.css">

<script src="/javascripts/common.js"></script>
<script src="/javascripts/displays.js"></script>

</head>

<body>

<div class="container-fluid">
    <div class="row vertical-center">
        <div class="col-md-12 col-sm-12">
            <div class="row current-display-box">
                <div class="col-md-8 col-sm-8 col-xs-10 col-md-offset-1 col-sm-offset-1">
                  <h1 class="current-display-label hr-color">HR:</h1>
                  <h2 id="current-hr-display" class="current-display hr-color"></h2>
                  <canvas width="400" height="80" class="display-waveform" id="hr-ecg-display"></canvas>
                </div>
                <div class="col-md-3 col-sm-3 col-xs-2">
                    <h1 class="current-display-label">Time:</h1>
                    <h2 id="current-time-display" class="current-display"></h2>
                </div>
            </div>
            <div class="row current-display-box">
                <div class="col-md-8 col-sm-8 col-xs-10 col-md-offset-1 col-sm-offset-1">
                  <h1 class="current-display-label spo2-color">SpO<sub>2</sub>:</h1>
                  <h2 id="current-spo2-display" class="current-display spo2-color"></h2>
                  <canvas width="400" height="80" class="display-waveform" id="spo2-ppg-display"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <span id="status-connection" class="label label-danger">Not connected to simulation server!</span>
    </div>
</div>

<script>
var socket = io.connect(window.location.host);
var socketConnection = new SocketConnection({
    connectionStatusElem: 'status-connection',
    socket: socket
});
var apgarTime = new ReadableValue({
    elem: 'current-time-display',
    units: 'time',
    min: 0,
    missingString: '???',
    socket: socket,
    messageName: 'tick'
});
var hr = new ReadableValue({
    elem: 'current-hr-display',
    units: 'bpm',
    min: 0,
    max: 200,
    missingString: '???'
});
var ecg = new WaveformDisplay('hr-ecg-display', '#F0E442', 3, 30, 60, 1, ecgData);
ecg.draw();
var spO2 = new ReadableValue({
    elem: 'current-spo2-display',
    units: '%',
    min: 0,
    max: 100,
    missingString: '???'
});
var ppg = new WaveformDisplay('spo2-ppg-display', '#00FFFF', 3, 40, 75, 1, ppgData);
ppg.draw();

function setCurrentDisplay(time, spO2Value, fiO2, hrValue) {
    apgarTime.update(time);
    spO2.update(spO2Value);
    hr.update(hrValue);
    if (hrValue === undefined || hrValue === null || isNaN(hrValue)) {
        ecg.disconnect();
        ppg.disconnect();
    } else {
        hrValue = Math.round(hrValue);
        ecg.connect();
        ppg.connect();
        ecg.setFrequency(hrValue);
        ppg.setFrequency(hrValue);
    }
}

socket.on('initialize', function(data) {
    if (data === null) {
        console.log('Sockets: Initializing.');
        hr.update(null);
        spO2.update(null);
        return;
    }
    console.log('Sockets: Initializing with previous data.');
    setCurrentDisplay(data.time[data.time.length - 1], data.spO2[data.spO2.length - 1], data.fiO2[data.fiO2.length - 1], data.hr[data.hr.length - 1]);
    var time = data.time.map(toDateString);
    time.unshift('signalTime');
    var spO2Signal = data.spO2;
    spO2Signal.unshift('SpO2');
});
socket.on('update', function(data) {
    setCurrentDisplay(data.time, data.spO2, data.fiO2, data.hr);
});
socket.on('reset', function(data) {
    setCurrentDisplay(data.time, data.spO2, data.fiO2, data.hr);
    console.log('Sockets: Resetting data.');
});
socket.on('redirect', function(data) {
    console.log('Sockets: Redirecting to ' + data);
    window.location = data;
})
</script>

</body>
