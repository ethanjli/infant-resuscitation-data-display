<!doctype html>

<head>

<script src="/socket.io/socket.io.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>

<link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/css/bootstrap.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/js/bootstrap.min.js"></script>

<link type="text/css" rel="stylesheet" href="/stylesheets/display_panel.css">

<script src="/javascripts/common.js"></script>
<script src="/javascripts/displays.js"></script>

</head>

<body>

<div class="container-fluid">
    <div class="row vertical-center">
        <div id="current-display" class="col-md-12 col-sm-12">
            <div class="row current-display-box">
                <div class="col-md-8 col-sm-8 col-xs-10 col-md-offset-1 col-sm-offset-1">
                  <h1 class="current-display-label hr-color">HR:</h1>
                  <h2 id="current-hr-display" class="current-display hr-color">???</h2>
                  <canvas width="300" height="80" class="display-waveform" id="hr-ecg-display"></canvas>
                </div>
                <div class="col-md-3 col-sm-3 col-xs-2">
                    <h1 class="current-display-label">Time:</h1>
                    <h2 id="current-time-display" class="current-display"></h2>
                </div>
            </div>
            <div class="row current-display-box">
                <div class="col-md-8 col-sm-8 col-xs-10 col-md-offset-1 col-sm-offset-1">
                  <h1 class="current-display-label spo2-color">SpO<sub>2</sub>:</h1>
                  <h2 id="current-spo2-display" class="current-display spo2-color">???</h2>
                  <canvas width="300" height="80" class="display-waveform" id="spo2-ppg-display"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <span id="status-connection" class="label label-danger">Not connected to simulation server!</span>
    </div>
</div>

<script>
var socket = io.connect(window.location.host);
var apgarTime = new ReadableValue('current-time-display', 'time', socket, 'tick');
apgarTime.listen();
var ecg = new WaveformDisplay('hr-ecg-display', '#F0E442', 3, 30, 60, [
    0.0000050048828125, 0.0000137939453125, 0.000049560546875,
    0.00008740234375, 0.00015966796875, 0.000262451171875, 0.0003975830078125,
    0.0005687255859375, 0.0007802734375, 0.001037353515625, 0.0013468017578125,
    0.00172119140625, 0.0021756591796875, 0.0027232666015625, 0.0033880615234375,
    0.004206787109375, 0.0052380371093750005, 0.006586181640625, 0.008400146484375001,
    0.010904296875, 0.0144892578125, 0.0196798095703125, 0.049684204101562504,
    0.0886883544921875, 0.11185363769531251, 0.134164306640625, 0.137352294921875,
    0.1160369873046875, 0.08516308593750001, 0.0539765625, 0.014997436523437501,
    -0.015882568359375, -0.0387554931640625, -0.06125732421875, -0.0745780029296875,
    -0.07479357910156251, -0.0725338134765625, -0.0418538818359375,
    0.08582861328125001, 0.397717529296875, 0.8136408691406251, 1.2295617980957032,
    0.9944150390625001, 0.2824605712890625, -0.38949267578125, -0.597251220703125,
    -0.425675537109375, -0.1537947998046875, -0.0500914306640625, -0.0111041259765625,
    0.0027451171875, 0.0071739501953125, 0.008443359375, 0.0094327392578125,
    0.012530517578125, 0.0176046142578125, 0.0300162353515625, 0.0433489990234375,
    0.056962646484375004, 0.0704832763671875, 0.0770511474609375, 0.0898175048828125,
    0.10311853027343751, 0.117046142578125, 0.1312630615234375, 0.1529300537109375,
    0.167607177734375, 0.1899068603515625, 0.2124422607421875, 0.235044677734375,
    0.2575535888671875, 0.2724073486328125, 0.286978271484375, 0.3007579345703125,
    0.3067425537109375, 0.3106370849609375, 0.303756103515625, 0.2897236328125,
    0.25916931152343753, 0.2200599365234375, 0.1728209228515625, 0.133416259765625,
    0.086224853515625, 0.05493408203125, 0.02409423828125, 0.00922607421875,
    -0.0043409423828125, -0.0097349853515625, -0.013127685546875, -0.01423095703125,
    -0.013834716796875, -0.012556030273437501, -0.010675048828125, -0.00835888671875,
    -0.0057305908203125, -0.0000562744140625, 0, 0, 0, 0
]);
ecg.draw();
var ppg = new WaveformDisplay('spo2-ppg-display', '#00BA86', 3, 30, 60, [
    0.0000050048828125, 0.0000137939453125, 0.000049560546875,
    0.00008740234375, 0.00015966796875, 0.000262451171875, 0.0003975830078125,
    0.0005687255859375, 0.0007802734375, 0.001037353515625, 0.0013468017578125,
    0.00172119140625, 0.0021756591796875, 0.0027232666015625, 0.0033880615234375,
    0.004206787109375, 0.0052380371093750005, 0.006586181640625, 0.008400146484375001,
    0.010904296875, 0.0144892578125, 0.0196798095703125, 0.049684204101562504,
    0.0886883544921875, 0.11185363769531251, 0.134164306640625, 0.137352294921875,
    0.1160369873046875, 0.08516308593750001, 0.0539765625, 0.014997436523437501,
    -0.015882568359375, -0.0387554931640625, -0.06125732421875, -0.0745780029296875,
    -0.07479357910156251, -0.0725338134765625, -0.0418538818359375,
    0.08582861328125001, 0.397717529296875, 0.8136408691406251, 1.2295617980957032,
    0.9944150390625001, 0.2824605712890625, -0.38949267578125, -0.597251220703125,
    -0.425675537109375, -0.1537947998046875, -0.0500914306640625, -0.0111041259765625,
    0.0027451171875, 0.0071739501953125, 0.008443359375, 0.0094327392578125,
    0.012530517578125, 0.0176046142578125, 0.0300162353515625, 0.0433489990234375,
    0.056962646484375004, 0.0704832763671875, 0.0770511474609375, 0.0898175048828125,
    0.10311853027343751, 0.117046142578125, 0.1312630615234375, 0.1529300537109375,
    0.167607177734375, 0.1899068603515625, 0.2124422607421875, 0.235044677734375,
    0.2575535888671875, 0.2724073486328125, 0.286978271484375, 0.3007579345703125,
    0.3067425537109375, 0.3106370849609375, 0.303756103515625, 0.2897236328125,
    0.25916931152343753, 0.2200599365234375, 0.1728209228515625, 0.133416259765625,
    0.086224853515625, 0.05493408203125, 0.02409423828125, 0.00922607421875,
    -0.0043409423828125, -0.0097349853515625, -0.013127685546875, -0.01423095703125,
    -0.013834716796875, -0.012556030273437501, -0.010675048828125, -0.00835888671875,
    -0.0057305908203125, -0.0000562744140625, 0, 0, 0, 0
]);
ppg.draw();

function updateStatusConnected() {
    var statusElem = document.getElementById('status-connection');
    statusElem.innerHTML = 'Connected to sensors';
    statusElem.className = 'label label-default';
    statusElem.style.visibility = 'hidden';
}
function updateStatusDisconnected() {
    var statusElem = document.getElementById('status-connection');
    statusElem.innerHTML = 'Not connected to sensors!';
    statusElem.className = 'label label-danger';
    statusElem.style.visibility = 'visible';
}

function setCurrentDisplay(time, spO2, fiO2, hr) {
    apgarTime.update(time);
    if (spO2 === null || isNaN(spO2)) {
        spO2 = '???';
    } else {
        spO2 = Math.round(spO2 * 100) + '%'
    }
    document.getElementById('current-spo2-display').innerHTML = spO2;
    if (hr === null || isNaN(hr)) {
        hr = '???';
    } else {
        hr = Math.round(hr)
    }
    document.getElementById('current-hr-display').innerHTML = hr;
}

function updateDisplay(time, spO2, fiO2, hr) {
    var dateString = toDateString(time);
    if (spO2 === null) {
        spO2 = NaN;
    }
    if (hr === null) {
        hr = NaN;
    }
    setCurrentDisplay(time, spO2, fiO2, hr);
}

socket.on('connect', function(data) {
    socket.emit('connected', {client: 'display-panel'});
    console.log('Sockets: Connected to server.');
    updateStatusConnected();
})
socket.on('disconnect', function(data) {
    console.log('Sockets: Disconnected from server.');
    updateStatusDisconnected();
})
socket.on('initialize', function(data) {
    if (data === null) {
        console.log('Sockets: Initializing.');
        document.getElementById('current-spo2-display').innerHTML = '???';
        return;
    } else {
        console.log('Sockets: Initializing with previous data.');
    }
    setCurrentDisplay(data.time[data.time.length - 1], data.spO2[data.spO2.length - 1], data.fiO2[data.fiO2.length - 1], data.hr[data.hr.length - 1]);
    var time = data.time.map(toDateString);
    time.unshift('signalTime');
    var spO2Signal = data.spO2;
    spO2Signal.unshift('SpO2');
});
socket.on('update', function(data) {
    updateDisplay(data.time, data.spO2, data.fiO2, data.hr);
});
socket.on('reset', function(data) {
    setCurrentDisplay(data.time, data.spO2, data.fiO2, data.hr);
    console.log('Sockets: Resetting data.');
});
</script>

</body>
