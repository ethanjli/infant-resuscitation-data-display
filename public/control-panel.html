<!doctype html>

<head>

<script src="/socket.io/socket.io.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-mousewheel/3.1.13/jquery.mousewheel.min.js"></script>

<link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/css/bootstrap.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/js/bootstrap.min.js"></script>

<style>
.vertical-center {
    min-height: 90%;
    min-height: 90vh;

    display: flex;
    align-items: center;
}
</style>

</head>

<body>

<div class="container">
    <div class="row vertical-center text-center">
        <div class="col-md-12 text-center">
            <h1>Control Panel</h1>
            <div class="row">
                <span id="status-connection" class="label label-danger">Not connected to server</span> <span id="status-displays" class="label label-warning">No displays connected to server</span> <span id="status-hardware" class="label label-warning">No hardware interfaces connected to server</span>
                <hr>
                <div class="col-md-4">
                    <div class="panel panel-default">
                        <div class="panel-heading"><h3 class="panel-title">Simulation</h3></div>
                        <div class="panel-body">
                            <form class="form-horizontal">
                                <div class="form-group">
                                    <label class="col-sm-6 control-label">Apgar time</label>
                                    <div class="col-sm-6">
                                        <p class="form-control-static" id="apgar-time">00:00</p>
                                    </div>
                                </div>
                                <hr>
                                <div class="form-group">
                                    <div class="row">
                                        <label>Simulation state</label>
                                    </div>
                                    <div class="btn-group" role="group">
                                        <button type="button" id="btn-startreset-simulation" class="btn btn-default">Start</button>
                                        <button type="button" id="btn-pauseresume-simulation" class="btn btn-default">Pause</button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="row">
                                        <label>Sensor Connection</label>
                                    </div>
                                    <div class="btn-group-vertical" role="group">
                                        <button type="button" id="btn-connectdisconnect-sensors" class="btn btn-default">Connect Sensors</button>
                                        <button type="button" id="btn-delayedconnect-sensors" class="btn btn-default">Connect to Sensors in 15 Seconds</button>
                                    </div>
                                </div>
                            </form>
                            <hr>
                            <form action="/csv" method="get" target="_blank">
                                <div class="row">
                                    <label>Data Export</label>
                                </div>
                                <input type="submit" id="btn-download-csv" class="btn btn-default" value="Download Simulation Record">
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="panel panel-default">
                        <div class="panel-heading"><h3 class="panel-title">Vitals</h3></div>
                        <div class="panel-body form-horizontal">
                            <form class="form-horizontal">
                                <div class="form-group">
                                    <div class="row">
                                        <label>SpO<small>2</small> Signal Parameters</label>
                                    </div>
                                    <label for="input-spo2" class="col-sm-5 control-label">Signal Mean</label>
                                    <div class="input-group col-sm-5">
                                        <input type="number" id="input-spo2" class="form-control" placeholder="0" min="0" max="100" step="1">
                                        <div class="input-group-addon">%</div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="input-spo2-noise" class="col-sm-5 control-label">Signal Standard Deviation</label>
                                    <div class="input-group col-sm-5">
                                        <input type="number" id="input-spo2-noise" class="form-control" placeholder="0" min="0" max="100" step="1">
                                        <div class="input-group-addon">%</div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="row">
                                        <label>Auto-Adjust Signal Mean</label>
                                    </div>
                                    <div class="btn-group-vertical" role="group">
                                        <button type="button" id="btn-spo2-autoincrease" class="btn btn-default">Increase by 1%/sec</button>
                                        <button type="button" id="btn-spo2-autodecrease" class="btn btn-default">Decrease by 1%/sec</button>
                                    </div>
                                </div>
                                <hr>
                                <div class="form-group">
                                    <label for="input-hr" class="col-sm-5 control-label">Heart Rate</label>
                                    <div class="input-group col-sm-5">
                                        <input type="number" id="input-hr" class="form-control" placeholder="0" min="0" max="200" step="1">
                                        <div class="input-group-addon">bpm</div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="panel panel-default">
                        <div class="panel-heading"><h3 class="panel-title">Air Supply</h3></div>
                        <div class="panel-body form-horizontal">
                            <form class="form-horizontal">
                                <div class="form-group">
                                    <label for="input-fio2" class="col-sm-6 control-label">FiO<sub>2</sub></label>
                                    <div class="input-group col-sm-5">
                                        <input type="number" id="input-fio2" class="form-control" placeholder="0" min="0" max="100" step="1">
                                        <div class="input-group-addon">%</div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>

function updateStatusConnected() {
    var statusElem = document.getElementById('status-connection');
    statusElem.innerHTML = 'Connected to server';
    statusElem.className = 'label label-success';
}
function updateStatusDisconnected() {
    var statusElem = document.getElementById('status-connection');
    statusElem.innerHTML = 'Not connected to server';
    statusElem.className = 'label label-danger';
}
function updateStatusMultipleConnected(numControlPanels) {
    var statusElem = document.getElementById('status-connection');
    statusElem.innerHTML = numControlPanels + ' control panels connected to server';
    statusElem.className = 'label label-info';
}
function updateStatusDisplaysConnected(numDisplays) {
    var statusElem = document.getElementById('status-displays');
    if (numDisplays > 1) {
        statusElem.innerHTML = numDisplays + ' displays connected to server';
    } else if (numDisplays === 1) {
        statusElem.innerHTML = 'Display connected to server';
    }
    statusElem.className = 'label label-success';
}
function updateStatusDisplaysDisconnected() {
    var statusElem = document.getElementById('status-displays');
    statusElem.innerHTML = 'No display connected to server';
    statusElem.className = 'label label-warning';
}
function updateStatusHardwareConnected(numDisplays) {
    var statusElem = document.getElementById('status-hardware');
    var fiO2Elem = document.getElementById('input-fio2');
    if (numDisplays > 1) {
        statusElem.innerHTML = numDisplays + ' hardware interfaces connected to server';
    } else if (numDisplays === 1) {
        statusElem.innerHTML = 'Hardware interface connected to server';
    }
    fiO2Elem.setAttribute('readonly', 'readonly');
    statusElem.className = 'label label-success';
}
function updateStatusHardwareDisconnected() {
    var statusElem = document.getElementById('status-hardware');
    var fiO2Elem = document.getElementById('input-fio2');
    statusElem.innerHTML = 'No hardware interface connected to server';
    statusElem.className = 'label label-warning';
    fiO2Elem.removeAttribute('readonly');
}
function updateSimulationStarted() {
    var startResetBtn = document.getElementById('btn-startreset-simulation');
    var pauseResumeBtn = document.getElementById('btn-pauseresume-simulation');
    var downloadBtn = document.getElementById('btn-download-csv');
    startResetBtn.disabled = '';
    startResetBtn.innerHTML = 'Reset';
    pauseResumeBtn.disabled = '';
    pauseResumeBtn.innerHTML = 'Pause';
    downloadBtn.disabled = '';
}
function updateSimulationReady() {
    var startResetBtn = document.getElementById('btn-startreset-simulation');
    var pauseResumeBtn = document.getElementById('btn-pauseresume-simulation');
    var downloadBtn = document.getElementById('btn-download-csv');
    startResetBtn.disabled = '';
    startResetBtn.innerHTML = 'Start';
    pauseResumeBtn.disabled = 'disabled';
    pauseResumeBtn.innerHTML = 'Pause';
    downloadBtn.disabled = 'disabled';
}
function updateSimulationPaused() {
    var startResetBtn = document.getElementById('btn-startreset-simulation');
    var pauseResumeBtn = document.getElementById('btn-pauseresume-simulation');
    startResetBtn.disabled = '';
    startResetBtn.innerHTML = 'Reset';
    pauseResumeBtn.disabled = '';
    pauseResumeBtn.innerHTML = 'Resume';
}
function updateSensorConnection(sensorConnection) {
    var sensorConnectionBtn = document.getElementById('btn-connectdisconnect-sensors');
    var delayedSensorConnectionBtn = document.getElementById('btn-delayedconnect-sensors');
    if (sensorConnection) {
        sensorConnectionBtn.innerHTML = 'Disconnect Sensors';
        delayedSensorConnectionBtn.innerHTML = 'Connected to Sensors';
        delayedSensorConnectionBtn.disabled = 'disabled';
    } else {
        sensorConnectionBtn.innerHTML = 'Connect Sensors';
        delayedSensorConnectionBtn.innerHTML = 'Connect to Sensors in 15 Seconds';
        delayedSensorConnectionBtn.disabled = '';
    }
    sensorConnectionBtn.disabled = '';
}
function toDateString(totalSeconds) {
    var minutes = parseInt(totalSeconds / 60) % 60;
    var seconds = totalSeconds % 60;
    return (minutes < 10 ? '0' + minutes : minutes) + ':' + (seconds < 10 ? '0' + seconds : seconds);
}
function updateTime(time) {
    var timeElem = document.getElementById('apgar-time');
    timeElem.innerHTML = toDateString(time);
}
function updateSpO2(spO2) {
    var spO2Elem = document.getElementById('input-spo2');
    spO2Elem.value = Math.round(spO2 * 100);
    afterSpO2Change();
}
function updateSpO2Noise(spO2Noise) {
    var spO2NoiseElem = document.getElementById('input-spo2-noise');
    spO2NoiseElem.value = Math.round(spO2Noise * 100);
}
function updateFiO2(fiO2) {
    var fiO2Elem = document.getElementById('input-fio2');
    fiO2Elem.value = Math.round(fiO2 * 100);
}
function updateHR(hr) {
    var hrElem = document.getElementById('input-hr');
    hrElem.value = hr;
}
function afterSpO2Change() {
    var spO2Elem = document.getElementById('input-spo2');
    var autoIncreaseBtn = document.getElementById('btn-spo2-autoincrease');
    var autoDecreaseBtn = document.getElementById('btn-spo2-autodecrease');
    if (parseInt(spO2Elem.value) === parseInt(spO2Elem.max)) {
        autoIncreaseBtn.disabled = 'disabled';
        autoIncreaseBtn.innerHTML = 'Can\'t Increase Beyond ' + spO2Elem.max + '%';
        autoDecreaseBtn.disabled = '';
        clearInterval(spO2AutoAdjustTimer);
    } else if (parseInt(spO2Elem.value) === parseInt(spO2Elem.min)) {
        autoDecreaseBtn.disabled = 'disabled';
        autoDecreaseBtn.innerHTML = 'Can\'t Decrease Beyond ' + spO2Elem.min + '%';
        autoIncreaseBtn.disabled = '';
        clearInterval(spO2AutoAdjustTimer);
    } else {
        if (autoIncreaseBtn.innerHTML === ('Can\'t Increase Beyond' + spO2Elem.max + '%')) {
            autoIncreaseBtn.innerHTML = 'Increase by 1%/sec';
            autoIncreaseBtn.disabled = '';
        }
        if (autoDecreaseBtn.innerHTML === ('Can\'t Decrease Beyond' + spO2Elem.max + '%')) {
            autoDecreaseBtn.innerHTML = 'Decrease by 1%/sec';
            autoDecreaseBtn.disabled = '';
        }
    }
}

var socket = io.connect(window.location.host);
socket.on('connect', function(data) {
    socket.emit('connected', {client: 'control-panel'});
    console.log('Sockets: Connected to server.');
    updateStatusConnected();
});
socket.on('disconnect', function(data) {
    console.log('Sockets: Disconnected from server.');
    updateStatusDisconnected();
});
socket.on('control-connection-info', function(data) {
    if (data > 1) {
        updateStatusMultipleConnected(data);
    } else if (data == 1) {
        updateStatusConnected();
    }
});
socket.on('display-connection-info', function(data) {
    if (data > 0) {
        updateStatusDisplaysConnected(data);
    } else {
        updateStatusDisplaysDisconnected();
    }
});
socket.on('hardware-connection-info', function(data) {
    if (data > 0) {
        updateStatusHardwareConnected(data);
    } else {
        updateStatusHardwareDisconnected();
    }
});
socket.on('simulation-state-info', function(data) {
    console.log('Sockets: Simulation state is: ' + data);
    if (data === 'ready') {
        updateSimulationReady();
    } else if (data === 'running') {
        updateSimulationStarted();
    } else if (data === 'stopped') {
        updateSimulationPaused();
    }
});
socket.on('start', function(data) {
    console.log('Sockets: Starting simulation.');
    updateSimulationStarted();
});
socket.on('reset', function(data) {
    console.log('Sockets: Resetting simuluation.');
    updateSimulationReady();
});
socket.on('stop', function(data) {
    console.log('Sockets: Stopping simuluation.');
    updateSimulationPaused();
});
socket.on('sensor-connection', function(data) {
    if (data) {
        console.log('Sockets: Connecting sensors');
    } else {
        console.log('Sockets: Disconnecting sensors');
    }
    updateSensorConnection(data);
});
socket.on('tick', updateTime);
socket.on('spO2', function(data) {
    console.log('Sockets: Updating SpO2 level to ' + data + '.');
    updateSpO2(data);
});
socket.on('spO2-noise', function(data) {
    console.log('Sockets: Updating SpO2 noise range to +/- ' + data + '.');
    updateSpO2Noise(data);
});
socket.on('fiO2', function(data) {
    console.log('Sockets: Updating FiO2 level to ' + data + '.');
    updateFiO2(data);
});
socket.on('hr', function(data) {
    console.log('Sockets: Updating HR to ' + data + '.');
    updateHR(data);
});

var spO2AutoAdjustTimer, hrAutoAdjustTimer;
document.getElementById('btn-startreset-simulation').onclick = function() {
    var startResetBtn = document.getElementById('btn-startreset-simulation');
    var pauseResumeBtn = document.getElementById('btn-pauseresume-simulation');
    if (startResetBtn.innerHTML === 'Start') {
        socket.emit('start');
    } else if (startResetBtn.innerHTML === 'Reset') {
        socket.emit('reset');
    }
    startResetBtn.disabled = 'disabled';
    pauseResumeBtn.disabled = 'disabled';
};
document.getElementById('btn-pauseresume-simulation').onclick = function() {
    var startResetBtn = document.getElementById('btn-startreset-simulation');
    var pauseResumeBtn = document.getElementById('btn-pauseresume-simulation');
    if (pauseResumeBtn.innerHTML === 'Pause') {
        socket.emit('stop');
    } else if (pauseResumeBtn.innerHTML === 'Resume') {
        socket.emit('start');
    }
    startResetBtn.disabled = 'disabled';
    pauseResumeBtn.disabled = 'disabled';
};
document.getElementById('btn-connectdisconnect-sensors').onclick = function() {
    var sensorsBtn = document.getElementById('btn-connectdisconnect-sensors');
    var delayedSensorBtn = document.getElementById('btn-delayedconnect-sensors');
    if (sensorsBtn.innerHTML === 'Connect Sensors') {
        socket.emit('sensor-connection', true);
        delayedSensorBtn.innerHTML = 'Connected to Sensors';
        delayedSensorBtn.disabled = 'disabled';
    } else if (sensorsBtn.innerHTML === 'Disconnect Sensors') {
        delayedSensorBtn.innerHTML = 'Connect Sensors in 15 Seconds';
        socket.emit('sensor-connection', false);
    }
    sensorsBtn.disabled = 'disabled';
};
document.getElementById('btn-delayedconnect-sensors').onclick = function() {
    var sensorsBtn = document.getElementById('btn-connectdisconnect-sensors');
    var delayedSensorBtn = document.getElementById('btn-delayedconnect-sensors');
    var delay = 15;
    for (i = 1; i < delay; i++) {
        setTimeout((function(countdown) {
            console.log('Connecting in ' + (15 - countdown) + 's...');
            delayedSensorBtn.innerHTML = 'Connecting in ' + (15 - countdown) + 's...';
        }).bind(this, i), i * 1000);
    }
    setTimeout(function() {
        socket.emit('sensor-connection', true);
        delayedSensorBtn.innerHTML = 'Connected to Sensors';
    }, delay * 1000);
    delayedSensorBtn.disabled = 'disabled';
    sensorsBtn.disabled = 'disabled';
};
document.getElementById('input-spo2').onchange = function() {
    var spO2Elem = document.getElementById('input-spo2');
    afterSpO2Change();
    socket.emit('spO2', spO2Elem.value / 100);
};
document.getElementById('input-spo2-noise').onchange = function() {
    var spO2NoiseElem = document.getElementById('input-spo2-noise');
    socket.emit('spO2-noise', spO2NoiseElem.value / 100);
};
document.getElementById('btn-spo2-autoincrease').onclick = function() {
    var spO2Elem = document.getElementById('input-spo2');
    var autoIncreaseBtn = document.getElementById('btn-spo2-autoincrease');
    var autoDecreaseBtn = document.getElementById('btn-spo2-autodecrease');
    clearInterval(spO2AutoAdjustTimer);
    if (autoIncreaseBtn.innerHTML === 'Increase by 1%/sec') {
        autoIncreaseBtn.innerHTML = 'Stop Auto-Increasing';
        autoDecreaseBtn.innerHTML = 'Decrease by 1%/sec';
        autoDecreaseBtn.disabled = '';
        spO2AutoAdjustTimer = setInterval(function() {
            spO2Elem.value = Math.max(parseInt(spO2Elem.min),
                                      Math.min(parseInt(spO2Elem.max),
                                               parseInt(spO2Elem.value) + 1));
            spO2Elem.onchange();
        }, 1000);
    } else if (autoIncreaseBtn.innerHTML === 'Stop Auto-Increasing') {
        autoIncreaseBtn.innerHTML = 'Increase by 1%/sec';
    }
}
document.getElementById('btn-spo2-autodecrease').onclick = function() {
    var spO2Elem = document.getElementById('input-spo2');
    var autoIncreaseBtn = document.getElementById('btn-spo2-autoincrease');
    var autoDecreaseBtn = document.getElementById('btn-spo2-autodecrease');
    clearInterval(spO2AutoAdjustTimer);
    if (autoDecreaseBtn.innerHTML === 'Decrease by 1%/sec') {
        autoDecreaseBtn.innerHTML = 'Stop Auto-Decreasing';
        autoIncreaseBtn.innerHTML = 'Increase by 1%/sec';
        autoIncreaseBtn.disabled = '';
        spO2AutoAdjustTimer = setInterval(function() {
            spO2Elem.value = Math.max(parseInt(spO2Elem.min),
                                      Math.min(parseInt(spO2Elem.max),
                                               parseInt(spO2Elem.value) - 1));
            spO2Elem.onchange();
        }, 1000);
    } else if (autoDecreaseBtn.innerHTML === 'Stop Auto-Decreasing') {
        autoDecreaseBtn.innerHTML = 'Decrease by 1%/sec';
    }
}
document.getElementById('input-fio2').onchange = function() {
    var fiO2Elem = document.getElementById('input-fio2');
    socket.emit('fiO2', fiO2Elem.value / 100);
};
document.getElementById('input-hr').onchange = function() {
    var hrElem = document.getElementById('input-hr');
    socket.emit('hr', hrElem.value);
};

$(function() {
    $(':input[type="number"]').on('mousewheel', function(event) {
        event.target.value = parseInt(event.target.value) + event.deltaY;
        if (event.target.min !== undefined) {
            event.target.value = Math.max(event.target.min, event.target.value);
        }
        if (event.target.max !== undefined) {
            event.target.value = Math.min(event.target.max, event.target.value);
        }
        event.target.onchange();
    });
});

</script>

</body>
