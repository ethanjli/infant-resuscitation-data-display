<!doctype html>

<head>

<script src="/socket.io/socket.io.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-mousewheel/3.1.13/jquery.mousewheel.min.js"></script>

<link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/css/bootstrap.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/js/bootstrap.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.15.0/lodash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/machina.js/2.0.0/machina.min.js"></script>

<script src="/javascripts/common.js"></script>
<script src="/javascripts/controls.js"></script>

<style>
.vertical-center {
    min-height: 90%;
    min-height: 90vh;

    display: flex;
    align-items: center;
}
</style>

</head>

<body>

<div class="container">
    <div class="row vertical-center text-center">
        <div class="col-md-12 text-center">
            <h1>Control Panel</h1>
            <div class="row">
                <span id="status-connection" class="label label-danger">Not connected to server</span> <span id="status-displays" class="label label-warning">No displays connected to server</span> <span id="status-hardware" class="label label-warning">No hardware interfaces connected to server</span>
                <hr>
                <div class="col-md-4">
                    <div class="panel panel-default">
                        <div class="panel-heading"><h3 class="panel-title">Simulation</h3></div>
                        <div class="panel-body">
                            <form class="form-horizontal">
                                <div class="form-group">
                                    <label class="col-sm-6 control-label">Apgar time</label>
                                    <div class="col-sm-6">
                                        <p class="form-control-static" id="apgar-time"></p>
                                    </div>
                                </div>
                                <hr>
                                <div class="form-group">
                                    <div class="row">
                                        <label>Simulation state</label>
                                    </div>
                                    <div class="btn-group" role="group">
                                        <button type="button" id="btn-startreset-simulation" class="btn btn-default"></button>
                                        <button type="button" id="btn-pauseresume-simulation" class="btn btn-default"></button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="row">
                                        <label>Sensor Connection</label>
                                    </div>
                                    <div class="btn-group-vertical" role="group">
                                        <button type="button" id="btn-connectdisconnect-sensors" class="btn btn-default"></button>
                                        <button type="button" id="btn-delayedconnect-sensors" class="btn btn-default"></button>
                                    </div>
                                </div>
                            </form>
                            <hr>
                            <form action="/csv" method="get" target="_blank">
                                <div class="row">
                                    <label>Data Export</label>
                                </div>
                                <input type="submit" id="btn-download-csv" class="btn btn-default" value="Download Simulation Record">
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="panel panel-default">
                        <div class="panel-heading"><h3 class="panel-title">Vitals</h3></div>
                        <div class="panel-body form-horizontal">
                            <form class="form-horizontal">
                                <div class="form-group">
                                    <div class="row">
                                        <label>SpO<small>2</small> Signal Parameters</label>
                                    </div>
                                    <label for="input-spo2" class="col-sm-5 control-label">Signal Mean</label>
                                    <div class="input-group col-sm-5">
                                        <input type="number" id="input-spo2" class="form-control">
                                        <div id="input-spo2-units" class="input-group-addon"></div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="input-spo2-noise" class="col-sm-5 control-label">Signal Standard Deviation</label>
                                    <div class="input-group col-sm-5">
                                        <input type="number" id="input-spo2-noise" class="form-control">
                                        <div id="input-spo2-noise-units" class="input-group-addon"></div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="row">
                                        <label>Auto-Adjust Signal Mean</label>
                                    </div>
                                    <div class="btn-group-vertical" role="group">
                                        <button type="button" id="btn-spo2-autoincrease" class="btn btn-default"></button>
                                        <button type="button" id="btn-spo2-autodecrease" class="btn btn-default"></button>
                                    </div>
                                </div>
                                <hr>
                                <div class="form-group">
                                    <label for="input-hr" class="col-sm-5 control-label">Heart Rate</label>
                                    <div class="input-group col-sm-5">
                                        <input type="number" id="input-hr" class="form-control">
                                        <div id="input-hr-units" class="input-group-addon"></div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="row">
                                        <label>Auto-Adjust Heart Rate</label>
                                    </div>
                                    <div class="btn-group-vertical" role="group">
                                        <button type="button" id="btn-hr-autoincrease" class="btn btn-default"></button>
                                        <button type="button" id="btn-hr-autodecrease" class="btn btn-default"></button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="panel panel-default">
                        <div class="panel-heading"><h3 class="panel-title">Air Supply</h3></div>
                        <div class="panel-body form-horizontal">
                            <form class="form-horizontal">
                                <div class="form-group">
                                    <label for="input-fio2" class="col-sm-6 control-label">FiO<sub>2</sub></label>
                                    <div class="input-group col-sm-5">
                                        <input type="number" id="input-fio2" class="form-control">
                                        <div id="input-fio2-units" class="input-group-addon"></div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
var socket = io.connect(window.location.host);

var simulation = new Simulation({
    socket: socket,
    startResetBtn: 'btn-startreset-simulation',
    pauseResumeBtn: 'btn-pauseresume-simulation',
    downloadBtn: 'btn-download-csv'
});

var sensorConnection = new SensorConnection({
    socket: socket,
    sensorConnectionBtn: 'btn-connectdisconnect-sensors',
    delayedSensorConnectionBtn: 'btn-delayedconnect-sensors',
    delay: 15
});

var apgarTime = new ReadableValue('apgar-time', 'time', socket, 'tick');
apgarTime.listen();

var spO2 = new AdjustableValue({
    inputElem: 'input-spo2',
    unitsElem: 'input-spo2-units',
    units: '%',
    min: 0,
    max: 100,
    step: 1,
    placeholder: 0,
    socket: socket,
    messageName: 'spO2'
});
spO2.listen('Updating SpO2 level to ');
spO2.monitor();
var spO2AutoAdjuster = new AutoAdjuster({
    adjustableValue: spO2,
    autoIncreaseBtn: 'btn-spo2-autoincrease',
    autoDecreaseBtn: 'btn-spo2-autodecrease',
    incrementStep: 1,
    timeStep: 2
});

var spO2Noise = new AdjustableValue({
    inputElem: 'input-spo2-noise',
    unitsElem: 'input-spo2-noise-units',
    units: '%',
    min: 0,
    max: 100,
    step: 1,
    placeholder: 0,
    socket: socket,
    messageName: 'spO2-noise'
});
spO2Noise.listen('Updating SpO2 noise range to +/-');
spO2Noise.monitor();

var hr = new AdjustableValue({
    inputElem: 'input-hr',
    unitsElem: 'input-hr-units',
    units: ' bpm',
    min: 0,
    max: 140,
    step: 1,
    placeholder: 0,
    socket: socket,
    messageName: 'hr'
});
hr.listen('Updating HR to ');
hr.monitor();
var hrAutoAdjuster = new AutoAdjuster({
    adjustableValue: hr,
    autoIncreaseBtn: 'btn-hr-autoincrease',
    autoDecreaseBtn: 'btn-hr-autodecrease',
    incrementStep: 5,
    timeStep: 2
});

var fiO2 = new AdjustableValue({
    inputElem: 'input-fio2',
    unitsElem: 'input-fio2-units',
    units: '%',
    min: 21,
    max: 100,
    step: 1,
    placeholder: 21,
    socket: socket,
    messageName: 'fiO2'
});
fiO2.listen('Updating FiO2 level to ');
fiO2.monitor();

function updateStatusConnected() {
    var statusElem = document.getElementById('status-connection');
    statusElem.innerHTML = 'Connected to server';
    statusElem.className = 'label label-success';
}
function updateStatusDisconnected() {
    var statusElem = document.getElementById('status-connection');
    statusElem.innerHTML = 'Not connected to server';
    statusElem.className = 'label label-danger';
}
function updateStatusMultipleConnected(numControlPanels) {
    var statusElem = document.getElementById('status-connection');
    statusElem.innerHTML = numControlPanels + ' control panels connected to server';
    statusElem.className = 'label label-info';
}
function updateStatusDisplaysConnected(numDisplays) {
    var statusElem = document.getElementById('status-displays');
    if (numDisplays > 1) {
        statusElem.innerHTML = numDisplays + ' displays connected to server';
    } else if (numDisplays === 1) {
        statusElem.innerHTML = 'Display connected to server';
    }
    statusElem.className = 'label label-success';
}
function updateStatusDisplaysDisconnected() {
    var statusElem = document.getElementById('status-displays');
    statusElem.innerHTML = 'No display connected to server';
    statusElem.className = 'label label-warning';
}
function updateStatusHardwareConnected(numDisplays) {
    var statusElem = document.getElementById('status-hardware');
    if (numDisplays > 1) {
        statusElem.innerHTML = numDisplays + ' hardware interfaces connected to server';
    } else if (numDisplays === 1) {
        statusElem.innerHTML = 'Hardware interface connected to server';
    }
    fiO2.setReadOnly();
    statusElem.className = 'label label-success';
}
function updateStatusHardwareDisconnected() {
    var statusElem = document.getElementById('status-hardware');
    statusElem.innerHTML = 'No hardware interface connected to server';
    statusElem.className = 'label label-warning';
    fiO2.setWritable();
}

socket.on('connect', function(data) {
    socket.emit('connected', {client: 'control-panel'});
    console.log('Sockets: Connected to server.');
    updateStatusConnected();
    spO2.setWritable();
    spO2Noise.setWritable();
    hr.setWritable();
    fiO2.setWritable();
});
socket.on('disconnect', function(data) {
    console.log('Sockets: Disconnected from server.');
    updateStatusDisconnected();
    spO2.setReadOnly();
    spO2Noise.setReadOnly();
    hr.setReadOnly();
    fiO2.setReadOnly();
});
socket.on('control-connection-info', function(data) {
    if (data > 1) {
        updateStatusMultipleConnected(data);
    } else if (data == 1) {
        updateStatusConnected();
    }
});
socket.on('display-connection-info', function(data) {
    if (data > 0) {
        updateStatusDisplaysConnected(data);
    } else {
        updateStatusDisplaysDisconnected();
    }
});
socket.on('hardware-connection-info', function(data) {
    if (data > 0) {
        updateStatusHardwareConnected(data);
    } else {
        updateStatusHardwareDisconnected();
    }
});

$(function() {
    $(':input[type="number"]').on('mousewheel', function(event) {
        event.target.value = parseInt(event.target.value) + event.deltaY;
        if (event.target.min !== undefined) {
            event.target.value = Math.max(event.target.min, event.target.value);
        }
        if (event.target.max !== undefined) {
            event.target.value = Math.min(event.target.max, event.target.value);
        }
        event.target.onchange();
    });
});

</script>

</body>
