<!doctype html>

<head>

<link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.11/c3.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
<script src="c3.js"></script>

<style>
#chart .c3-axis {
    stroke-width: 4px;
}
#chart .c3-axis-x-label {
    font: 24px sans-serif;
}
#chart .c3-axis-y-label {
    font: 24px sans-serif;
}
#chart .c3-axis-y2-label {
    font: 24px sans-serif;
}
#chart .tick {
    font: 20px sans-serif;
}
#chart .c3-area {
    opacity: 1;
    stroke-width: 0px;
}
#chart .c3-line-SpO2 {
    stroke-width: 6px;
}
</style>

</head>

<body>

<div id="chart"></div>

<script>

function toDateString(totalSeconds) {
    var minutes = parseInt(totalSeconds / 60) % 60;
    var seconds = totalSeconds % 60;
    return (minutes < 10 ? '0' + minutes : minutes) + ':' + (seconds < 10 ? '0' + seconds : seconds);
}
function fromDateString(dateString) {
    var a = dateString.split(':');
    return a[0] * 60 + a[1] * 1;
}

var SpO2Signal = [0.35, 0.37, 0.38, 0.37, 0.38, 0.39, 0.39, 0.38, 0.39, 0.40, 0.41, 0.43, 0.44, 0.46, 0.47, 0.48, 0.48, 0.49, 0.51, 0.52, 0.51, 0.52, 0.53, 0.55, 0.56, 0.56, 0.57, 0.57, 0.60, 0.58, 0.57, 0.56, 0.58, 0.59, 0.60, 0.61, 0.62, 0.62, 0.63, 0.64, 0.60, 0.62, 0.65, 0.66, 0.68, 0.69, 0.68, 0.69, 0.70, 0.71, 0.72, 0.72, 0.71, 0.72, 0.73, 0.74, 0.70, 0.72, 0.71, 0.73, 0.75, 0.76, 0.79, 0.80, 0.82, 0.83, 0.85, 0.86, 0.87, 0.88, 0.87, 0.86, 0.87, 0.88, 0.89, 0.90, 0.91, 0.92, 0.91, 0.92, 0.92, 0.93, 0.92, 0.93, 0.93];
var signalTimes = Array.apply(null, Array(SpO2Signal.length)).map(function(_, i) {return toDateString(20 + 10 * i)})

var chart = c3.generate({
    bindto: '#chart',
    size: {
        width: 1200,
        height: 600,
    },
    data: {
        xs: {
            targetUpper: 'targetTime',
            targetLower: 'targetTime',
            SpO2: 'signalTime'
        },
        xFormat: '%M:%S',
        columns: [
            ['targetTime', toDateString(60), toDateString(300), toDateString(600), toDateString(2400)],
            ['targetUpper', 0.65, 0.85, 0.95, 0.95],
            ['targetLower', 0.6, 0.8, 0.85, 0.85],
            ['signalTime'],
            ['SpO2']
        ],
        types: {
            targetLower: 'area',
            targetUpper: 'area',
            SpO2: 'line'
        },
        axes: {
            targetLower: 'y',
            targetUpper: 'y',
            targetUpper: 'y2',
            SpO2: 'y2'
        },
        colors: {
            targetLower: 'white',
            targetUpper: 'salmon',
            SpO2: 'black'
        }
    },
    axis: {
        x: {
            label: {
                text: 'Time (min)',
                position: 'outer-center'
            },
            type: 'timeseries',
            tick: {
                format: '%M:%S',
                fit: false,
                culling: true
            },
            min: toDateString(0),
            max: toDateString(600),
            padding: 0,
            height: 60
        },
        y: {
            label: {
                text: 'Saturation (%)',
                position: 'outer-middle'
            },
            show: true,
            tick: {
                format: d3.format('%')
            },
            min: 0,
            max: 1,
            padding: 0
        },
        y2: {
            label: {
                text: 'Saturation (%)',
                position: 'outer-middle'
            },
            show: true,
            tick: {
                format: d3.format('%')
            },
            min: 0,
            max: 1,
            padding: 0
        }
    },
    legend: {
        show: false
    },
    tooltip: {
        show: false
    },
    point: {
        show: false
    },
    padding: {
        top: 20,
        left: 80,
        right: 80,
        bottom: 40
    }
});

function DataStreamer(delayInterval, rightPadding) {
    this.delayInterval = delayInterval;
    this.i = -1;
}
DataStreamer.prototype.flowChart = function() {
    chart.flow({
        columns: [
            ['signalTime', signalTimes[this.i]],
            ['SpO2', SpO2Signal[this.i]]
        ],
        duration: this.delayInterval,
        to: toDateString(0),
    });
}
DataStreamer.prototype.flowNext = function() {
    this.i = this.i + 1;
    if (this.i == signalTimes.length - 1) {
        return;
    }
    if (fromDateString(signalTimes[this.i]) > 600) {
        chart.axis.max({x: signalTimes[this.i]});
    }
    this.flowChart();
    setTimeout(this.flowNext.bind(this), this.delayInterval);
}
DataStreamer.prototype.startStreaming = function() {
    this.flowNext();
}
var dataStreamer = new DataStreamer(100);
dataStreamer.startStreaming();

</script>

</body>
